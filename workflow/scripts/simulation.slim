// set up a simple simulation
initialize() { 
	// parse out constants if using gui, otherwise these will be passed from command line
	if (exists("slimgui")) {
		defineConstant("ID", 1); // unique ID for simulation
		defineConstant("meanS", 0.02); // average selection coefficient for DFE
		defineConstant("alpha", 0.2); // shape parameter for DFE
		defineConstant("h", 0.1); // dominance coefficient
		defineConstant("sweepS", 0.02); // fitness effect of beneficial mutation
		defineConstant("sigmaA", 0.9); // ancestral selfing rate
		defineConstant("sigmaC", 0.1); // current selfing rate
		defineConstant("tsigma", 1000); // when selfing rate transition occurs
		defineConstant("tsweep", 5000); // when mutations become non-neutral
		defineConstant("N", 1000); // population size
		defineConstant("R", 1e-8); // recombination rate
		defineConstant("mu", 1e-6); // mutation rate
		defineConstant("G", 25000); // simulation length in generations
	}

	initializeMutationType("m0", 0.5, "f", 0.0); // neutral
	initializeMutationType("m4", 0.1, "g", meanS, alpha); // deleterious, background selection
	initializeMutationType("m5", h, "f", sweepS); // beneficial mutation
	
	initializeGenomicElementType("g0", m0, 1.0); // synonymous sites 
	initializeGenomicElementType("g4", m4, 1.0); // nonsynonymous sites

	initializeRecombinationRate(1e-8); // recombination 
	initializeMutationRate(1e-7);  // mutation rate

	// Load 4-fold and 0-fold degenerate sites
	types = asInteger(readFile("types_" + asString(ID) + ".txt"));
	starts = asInteger(readFile("starts_" + asString(ID) + ".txt"));

	// remove empty space at 5' end
	starts = starts - starts[0];

	// Create distribution of synonymous and nonsynonymous sites
	for (i in 0:(length(starts) - 1)) {
		type = types[i];
		start = starts[i];
		if (type == 4){
			initializeGenomicElement(g4, start, start); 
		}

		if (type == 0){
			initializeGenomicElement(g0, start, start); 
		} 
	} 

	// put starts vector in global scope so it can be accessed when adding beneficial mutation
	defineGlobal("nonsynSites", starts[(types ==4)]);
}
 
// initialize properties of population
1 early() { 
	sim.addSubpop("p1", asInteger(N)); // create a population
	community.rescheduleScriptBlock(s1, start=10*asInteger(N) + G, end=10*asInteger(N) + G); // output results at defined time
	community.rescheduleScriptBlock(s2, start=10*asInteger(N) + asInteger(tsigma), end=10*asInteger(N) + asInteger(tsigma)); // change selfing rate at defined time, first 10 N generations are burn-in
	community.rescheduleScriptBlock(s3, start=10*asInteger(N) + asInteger(tsweep), end=10*asInteger(N) + asInteger(tsweep)); // add in beneficial mutation at defined time, first 10N generations are burn-in
	// sim.rescheduleScriptBlock() method deprecated in slim 4: https://groups.google.com/g/slim-discuss/c/827_5SAIJtM/m/k074ovLSBAAJ
	// sim.rescheduleScriptBlock(s1, start = G, end = G); // set length of simulation
	p1.setSelfingRate(sigmaA); // set selfing rate for ancestral population
} 

// Change selfing rate
s2 5000 early() {
	print("Activating transition...");
	p1.setSelfingRate(sigmaC);
}

// Add new mutation
s3 10000 late() { 
 print("Introducing beneficial mutation...");
 print("Sample one genome...");
 target = sample(p1.genomes, 1);

 print("Sample one site..."); 
 mutsite = sample(nonsynSites, 1);

 print("Site of beneficial mutation:");
 print(mutsite);
 target.addNewDrawnMutation(m5, mutsite); 
} 

// run simulation for many generations
s1 2000 late() { 
	// output random sample of phased chromosomes
	//p1.outputMSSample(20, filePath = "slim.table", filterMonomorphic = T);
	
	// random sample of individuals from simulation
	g = p1.sampleIndividuals(128).genomes; 
 	
	// output sampled unphased genomes as VCF
	g.outputVCF(filePath = "slim_" + asString(ID) + ".vcf", simplifyNucleotides=F, outputNonnucleotides=T);
}
